# Check and Update Expected Anchors

Verify anchor integrity and update the database with new anchors. This command:

1. **Checks** for missing anchors (in database but not in HTML) - indicates broken links
2. **Finds** new anchors (in HTML but not in database) - can be added to tracking
3. **Updates** the database with new anchors (after confirmation)

Run this after adding/modifying content or before deploying to ensure all anchor links work.

## Configuration Files

### Main pages (index)
- `_resources/anchors_main_en.json` - English index anchors
- `_resources/anchors_main_ru.json` - Russian index anchors
- `_resources/anchors_main_ua.json` - Ukrainian index anchors
- `_resources/anchors_main_es.json` - Spanish index anchors

### Mortgage pages
- `_resources/anchors_mortgage_en.json` - English mortgage anchors
- `_resources/anchors_mortgage_ru.json` - Russian mortgage anchors
- `_resources/anchors_mortgage_ua.json` - Ukrainian mortgage anchors
- `_resources/anchors_mortgage_es.json` - Spanish mortgage anchors

## Excluded ID Patterns

The following ID patterns are **excluded** from anchor tracking because they are technical IDs (forms, scripts), not content anchors for navigation:

| Pattern | Description | Examples |
|---------|-------------|----------|
| `*-contact-form` | Contact form element IDs | `gestor-denis-contact-form`, `immigration-lawyer-natalya-contact-form` |
| `hs-script-loader` | HubSpot script loader ID | `hs-script-loader` |

These IDs are auto-generated by the build process and should not be tracked as content anchors.

## Prerequisites

**IMPORTANT**: The `_site/` directory must exist with compiled HTML files. If it doesn't exist, run:
```bash
bundle exec jekyll build
```

## Instructions

1. **Check if _site/ exists**
   ```bash
   ls _site/index.html _site/ru/index.html _site/ua/index.html _site/es/index.html _site/en/mortgage/index.html _site/ru/mortgage/index.html _site/ua/mortgage/index.html _site/es/mortgage/index.html
   ```
   If files don't exist, inform the user to run `bundle exec jekyll build` first.

2. **For each page**, extract ALL anchor IDs from the compiled HTML file:

   ### Main pages (index)

   | Language | HTML File | Expected Anchors JSON |
   |----------|-----------|----------------------|
   | EN | `_site/index.html` | `anchors_main_en.json` |
   | RU | `_site/ru/index.html` | `anchors_main_ru.json` |
   | UA | `_site/ua/index.html` | `anchors_main_ua.json` |
   | ES | `_site/es/index.html` | `anchors_main_es.json` |

   ### Mortgage pages

   | Language | HTML File | Expected Anchors JSON |
   |----------|-----------|----------------------|
   | EN | `_site/en/mortgage/index.html` | `anchors_mortgage_en.json` |
   | RU | `_site/ru/mortgage/index.html` | `anchors_mortgage_ru.json` |
   | UA | `_site/ua/mortgage/index.html` | `anchors_mortgage_ua.json` |
   | ES | `_site/es/mortgage/index.html` | `anchors_mortgage_es.json` |

3. **Extraction logic** - Extract all `id` attributes from HTML elements, excluding technical IDs:
   ```bash
   grep -oE 'id="[^"]+"' HTML_FILE | sed 's/id="//;s/"$//' | grep -v -E '(-contact-form$|^hs-script-loader$)' | sort -u
   ```

   This filters out:
   - IDs ending with `-contact-form` (contact form elements)
   - The `hs-script-loader` ID (HubSpot script)

4. **For each language**:
   - Read the current anchors_{page_type}_{lang}.json
   - Compare extracted anchors with existing anchors in database
   - Identify NEW anchors (present in HTML but not in database)
   - Identify REMOVED anchors (present in database but not in HTML)

5. **Run all 8 page scans in parallel** using the Task tool for efficiency.

## Output Format

### Summary Table

```
## Anchor Check & Update Results

### Main pages (index)

| Language | In Database | In HTML | New | Removed |
|----------|-------------|---------|-----|---------|
| EN       | 135         | 140     | 5   | 0       |
| RU       | 134         | 134     | 0   | 0       |
| UA       | 136         | 138     | 2   | 0       |
| ES       | 130         | 130     | 0   | 0       |

### Mortgage pages

| Language | In Database | In HTML | New | Removed |
|----------|-------------|---------|-----|---------|
| EN       | 25          | 26      | 1   | 0       |
| RU       | 25          | 25      | 0   | 0       |
| UA       | 25          | 25      | 0   | 0       |
| ES       | 25          | 25      | 0   | 0       |
```

### Missing/Removed Anchors Report (if any)

**IMPORTANT**: This is the CHECK phase. Missing anchors indicate potential broken links!

```
## ‚ùå Missing Anchors (in database but NOT in HTML)

These anchors may have been renamed without adding legacy anchors. URLs pointing to them will break!

### RU (1 missing)

1. `—Å—Ç–∞—Ä–æ–µ-–Ω–∞–∑–≤–∞–Ω–∏–µ`
   - URL: https://itautonomos.com/ru/#—Å—Ç–∞—Ä–æ–µ-–Ω–∞–∑–≤–∞–Ω–∏–µ
   - Fix: Add legacy anchor before renamed heading:
     ```markdown
     <span id="—Å—Ç–∞—Ä–æ–µ-–Ω–∞–∑–≤–∞–Ω–∏–µ" class="legacy-anchor"></span>
     ## –ù–æ–≤–æ–µ –ù–∞–∑–≤–∞–Ω–∏–µ
     ```
```

### New Anchors Report (if any)

```
## üÜï New Anchors Found (in HTML but not in database)

These can be added to the database for future tracking.

### EN (5 new)

1. `new-section-name`
2. `another-new-heading`
3. `feature-description`
...

### UA (2 new)

1. `–Ω–æ–≤–∏–π-—Ä–æ–∑–¥—ñ–ª`
2. `–¥–æ–¥–∞—Ç–∫–æ–≤–∞-—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è`
```

## Update Process

After showing the report:

1. **If missing anchors found**: Stop and warn the user. These need legacy anchors BEFORE proceeding. Do NOT update the database until missing anchors are resolved.

2. **If new anchors found** (and no missing): Ask user if they want to add them to the database

3. **If user confirms**: Update the JSON files:
   - Read current JSON file
   - Add new anchors to the `anchors` array
   - Sort the array alphabetically
   - Update `generated_at` to current date
   - Write updated JSON file

## JSON Update Format

When updating, maintain this structure:
```json
{
  "description": "Expected anchor IDs for {Language} {page_type}. Run /check-and-update-anchors to verify.",
  "language": "{lang}",
  "page_type": "index|mortgage",
  "source_file": "_site/{path}/index.html",
  "url": "https://itautonomos.com/{path}/",
  "generated_at": "YYYY-MM-DD",
  "anchors": [
    "anchor-1",
    "anchor-2",
    ...
  ]
}
```

## Final Summary

End with a clear status:

```
## Final Status

‚úÖ **ALL CHECKS PASSED** - No missing anchors, database is up to date.
```

OR

```
## Final Status

‚úÖ **DATABASE UPDATED** - All checks passed. Added X new anchor(s) to Y file(s).

Updated files:
- _resources/anchors_main_en.json (+5 anchors)
- _resources/anchors_main_ua.json (+2 anchors)
- _resources/anchors_mortgage_en.json (+1 anchors)
```

OR

```
## Final Status

‚ùå **MISSING ANCHORS FOUND** - X anchor(s) missing across Y page(s).

Action required: Add legacy anchors for the missing IDs listed above, then rebuild and re-run this command.
```

## Important Notes

- This command ADDS new anchors to the database, it does NOT remove existing ones
- Missing/removed anchors are reported as warnings for manual review (may need legacy anchors)
- Always rebuild (`bundle exec jekyll build`) before running this command
- New anchors should be reviewed to ensure they're intentional (not typos or temporary content)
- Both index pages and mortgage pages are checked and updated separately
